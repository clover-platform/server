<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="plus.xyc.server.i18n.entry.mapper.EntryMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="plus.xyc.server.i18n.entry.entity.dto.Entry">
        <id column="id" property="id" />
        <result column="module_id" property="moduleId" />
        <result column="branch_id" property="branchId" />
        <result column="identifier" property="identifier" />
        <result column="value" property="value" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="create_user_id" property="createUserId" />
        <result column="update_user_id" property="updateUserId" />
        <result column="deleted" property="deleted" />
        <result column="translated" property="translated" />
        <result column="result_id" property="resultId" />
        <result column="verified" property="verified" />
        <result column="translation_time" property="translationTime" />
        <result column="verification_time" property="verificationTime" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, module_id, branch_id, identifier, value, create_time, update_time, create_user_id, update_user_id, deleted,
        translated, result_id, verified, translation_time, verification_time
    </sql>

    <select id="findByModuleId" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from entry
        where
        module_id = #{moduleId,jdbcType=NUMERIC}
        and deleted = false
    </select>

    <select id="query" resultMap="BaseResultMap">
        select
        e.*
        from entry as e
        left join branch as b on e.branch_id = b.id
        where
        e.deleted = false and b.deleted = false
        <if test="query.branchId != null">
            and e.branch_id = #{query.branchId,jdbcType=NUMERIC}
        </if>
        <if test="query.moduleId != null">
            and e.module_id = #{query.moduleId,jdbcType=NUMERIC}
        </if>
        <if test="keyword != null">
            and (e.identifier like #{keyword,jdbcType=VARCHAR} or e.value like #{keyword,jdbcType=VARCHAR})
        </if>
    </select>

    <select id="countTotal" resultType="long">
        select
        count(1) as total
        from entry as e
        left join branch as b on e.branch_id = b.id
        where
        e.deleted = false and b.deleted = false
        <if test="request.branch != null">
            and b.name = #{request.branch}
        </if>
        <if test="request.moduleId != null">
            and e.module_id = #{request.moduleId,jdbcType=NUMERIC}
        </if>
    </select>

    <select id="countTranslated" resultType="long">
        select
        count(1) as total
        from entry as e
        left join branch as b on e.branch_id = b.id
        where
        e.deleted = false and b.deleted = false and e.translated = true
        <if test="request.branch != null">
            and b.name = #{request.branch}
        </if>
        <if test="request.moduleId != null">
            and e.module_id = #{request.moduleId,jdbcType=NUMERIC}
        </if>
    </select>

    <select id="countVerified" resultType="long">
        select
        count(1) as total
        from entry as e
        left join branch as b on e.branch_id = b.id
        where
        e.deleted = false and b.deleted = false and e.verified = true
        <if test="request.branch != null">
            and b.name = #{request.branch}
        </if>
        <if test="request.moduleId != null">
            and e.module_id = #{request.moduleId,jdbcType=NUMERIC}
        </if>
    </select>

    <select id="findByBranchId" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from entry
        where
        branch_id = #{branchId,jdbcType=NUMERIC}
        and deleted = false
    </select>

</mapper>
